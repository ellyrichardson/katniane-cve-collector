package com.katniane.katnianecvecollector.controller;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.io.OutputStream;
import java.net.HttpURLConnection;
import java.net.URL;
import java.util.ArrayList;
import java.util.List;

import org.json.JSONObject;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RestController;

import com.google.gson.JsonArray;
import com.google.gson.JsonElement;
import com.google.gson.JsonObject;
import com.google.gson.JsonParser;
import com.katniane.katnianecvecollector.dataaccesslayer.CveDetailDao;
import com.katniane.katnianecvecollector.domain.Cpe;
import com.katniane.katnianecvecollector.domain.Cve;
import com.katniane.katnianecvecollector.domain.Cve.CveDescription;
import com.katniane.katnianecvecollector.domain.Cve.CveWeakness;

import lombok.extern.slf4j.Slf4j;

@Slf4j
@RestController
@RequestMapping(value = "/")
public class CveCollectorController {
	
	private static final Logger LOG = LoggerFactory.getLogger(CveCollectorController.class);
	
	private static final String NVD_CVE_API = "https://services.nvd.nist.gov/rest/json/cves/2.0";
	
	private final CveDetailDao cveDetailDao;
	
	public CveCollectorController(CveDetailDao cveDetailDao) {
		this.cveDetailDao = cveDetailDao;
	}

	@RequestMapping(value = "/cpe/{cpeName}", method = RequestMethod.GET)
	public void getCveByCpeName(@PathVariable String cpeName) {
		LOG.info("Processing CPE name: {}", cpeName);
		if (!cveDetailDao.checkCpeExistence(cpeName)) {
			getCvesOfCpeFromNvdCveApi(cpeName);
		} else {
			getCvesOfCpeFromDB(cpeName);
		}
	}
	
	private void getCvesOfCpeFromNvdCveApi(String cpeName) {
		LOG.info("Retrieving CVE details from NVD CVE API for CPE: {}", cpeName);
		try {
			String urlEndpoint = NVD_CVE_API + "?" + "cpeName=" + cpeName;
			
			URL url = new URL (urlEndpoint);
			HttpURLConnection con = (HttpURLConnection)url.openConnection();
			
			con.setRequestMethod("GET");
			con.setRequestProperty("Content-Type", "application/json");
			con.setRequestProperty("Accept", "application/json");
			
			// TODO: Handle this RuntimeException
			if (con.getResponseCode() != 200) {
				throw new RuntimeException("Failed : HTTP error code : "
						+ con.getResponseCode());
			}
			
			// Read the Response From Input Stream
			try(BufferedReader br = new BufferedReader(
				new InputStreamReader(con.getInputStream(), "utf-8"))) {
				
				LOG.info("Received JSON response from NVD CVE API: {}", br.toString());
				
			    StringBuilder response = new StringBuilder();
			    String responseLine = null;
			    
			    while ((responseLine = br.readLine()) != null) {
			        response.append(responseLine.trim());
			    }
			    
			    List<Cve> cves = parseNvdCveApiResponse(response.toString());
			    
			    Cpe cpeObject = new Cpe();
			    cpeObject.setCves(cves);
			    cpeObject.setId(cpeName);
			    
			    cveDetailDao.saveCpeWithCve(cpeObject);
			}
		} catch (IOException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
	}
	
	private List<Cve> parseNvdCveApiResponse(String response) {
		List<Cve> cvesFound = new ArrayList<>();
		
		JsonElement jelement = JsonParser.parseString(response);
		JsonObject apiResult = jelement.getAsJsonObject();
		JsonArray vulnerabilities = apiResult.getAsJsonArray("vulnerabilities");
		
		// TODO: Check if all these cve elements are really needed for the project. Sounds like they all should be
		for (JsonElement vulnerability : vulnerabilities) {
			JsonObject vulnerabilityInfo = vulnerability.getAsJsonObject();
			JsonObject cveDetails = vulnerabilityInfo.get("cve").getAsJsonObject();
			//Cve.Builder();
			Cve cve = new Cve();
			cve.setId(getJsonElementAsString(cveDetails.get("id")));
			cve.setSourceIdentifier(getJsonElementAsString(cveDetails.get("sourceIdentifier")));
			cve.setPublished(getJsonElementAsString(cveDetails.get("published")));
			cve.setLastModified(getJsonElementAsString(cveDetails.get("lastModified")));
			cve.setVulnStatus(getJsonElementAsString(cveDetails.get("vulnStatus")));
			cve.setCisaActionDue(getJsonElementAsString(cveDetails.get("cisaActionDue")));
			cve.setCisaExploitAdd(getJsonElementAsString(cveDetails.get("cisaExploitAdd")));
			cve.setCisaRequiredAction(getJsonElementAsString(cveDetails.get("cisaRequiredAction")));
			cve.setCisaVulnerabilityName(getJsonElementAsString(cveDetails.get("cisaVulnerabilityName")));
			cve.setDescriptions(parseCveDescriptionsDetails(cve, cveDetails.getAsJsonArray("descriptions")));
			cve.setWeaknesses(parseCveWeaknessesDetails(cve, cveDetails.getAsJsonArray("weaknesses")));
			cve.setConfigurations(null);
			cve.setMetrics(null);
			cve.setReferences(null);
			// TODO: add the other elements
			cvesFound.add(cve);
		}
		
		return cvesFound;
	}
	
	private List<CveDescription> parseCveDescriptionsDetails(Cve cve, JsonArray cveDescriptionJsonArray) {
		List<CveDescription> cveDescriptions = new ArrayList<>();
		for (JsonElement cveDescriptionJsonElement : cveDescriptionJsonArray) {
			JsonObject cveDescriptionJsonObject = cveDescriptionJsonElement.getAsJsonObject();
			
			CveDescription cveDescription = cve.new CveDescription();
			cveDescription.setLang(getJsonElementAsString(cveDescriptionJsonObject.get("lang")));
			cveDescription.setValue(getJsonElementAsString(cveDescriptionJsonObject.get("value")));
			
			cveDescriptions.add(cveDescription);
		}
		
		return cveDescriptions;
	}
	
	private List<CveWeakness> parseCveWeaknessesDetails(Cve cve, JsonArray cveWeaknessJsonArray) {
		List<CveWeakness> cveWeaknesses = new ArrayList<>();
		for (JsonElement cveWeaknessJsonElement : cveWeaknessJsonArray) {
			JsonObject cveWeaknessJsonObject = cveWeaknessJsonElement.getAsJsonObject();
			
			CveWeakness cveWeakness = cve.new CveWeakness();
			cveWeakness.setType(getJsonElementAsString(cveWeaknessJsonObject.get("type")));
			cveWeakness.setSource(getJsonElementAsString(cveWeaknessJsonObject.get("source")));
			cveWeakness.setDescription(parseCveDescriptionsDetails(cve, cveWeaknessJsonObject.getAsJsonArray("description")));
			
			cveWeaknesses.add(cveWeakness);
		}
		
		return cveWeaknesses;
	}
	
	private String getJsonElementAsString(JsonElement jsonElement) {
		if (jsonElement == null) {
			return "";
		}
		return jsonElement.getAsString();
	}
	
	private void getCvesOfCpeFromDB(String cpeName) {
		LOG.info("Retrieving CVE details from Katniane DB for CPE: {}", cpeName);
	}
}
